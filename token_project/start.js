#!/usr/bin/env node

const chalk = require('chalk');
const inquirer = require('inquirer');
const fs = require('fs-extra');
const LunacoinSystem = require('./index');
const SystemTester = require('./test');

class SystemLauncher {
  constructor() {
    this.system = new LunacoinSystem();
    this.tester = new SystemTester();
  }

  // Mostra banner di avvio
  showStartupBanner() {
    console.clear();
    console.log(chalk.magenta('üåô'.repeat(60)));
    console.log(chalk.magenta('üåô') + chalk.white('                                                          ') + chalk.magenta('üåô'));
    console.log(chalk.magenta('üåô') + chalk.cyan('              LUNACOIN AUTONOMOUS SYSTEM                  ') + chalk.magenta('üåô'));
    console.log(chalk.magenta('üåô') + chalk.yellow('                Sistema Autonomo SPL Token                ') + chalk.magenta('üåô'));
    console.log(chalk.magenta('üåô') + chalk.white('                                                          ') + chalk.magenta('üåô'));
    console.log(chalk.magenta('üåô'.repeat(60)));
    console.log('');
    console.log(chalk.blue('üöÄ Benvenuto nel Sistema Autonomo LUNACOIN!'));
    console.log(chalk.white('   Il sistema pi√π avanzato per la creazione e gestione di token SPL su Solana'));
    console.log('');
    console.log(chalk.green('‚ú® Caratteristiche:'));
    console.log(chalk.white('   üéØ Generazione automatica token SPL'));
    console.log(chalk.white('   üîç Validazione unicit√† nome e simbolo'));
    console.log(chalk.white('   üåä Listing automatico sui DEX (Raydium, Orca, Jupiter)'));
    console.log(chalk.white('   üîí Gestione sicurezza e liquidit√†'));
    console.log(chalk.white('   üìä Monitoraggio continuo e alert'));
    console.log(chalk.white('   üîß Correzioni automatiche'));
    console.log(chalk.white('   üíæ Sistema di backup completo'));
    console.log('');
  }

  // Menu di avvio
  async showStartupMenu() {
    const choices = [
      {
        name: 'üöÄ Avvia Sistema Completo',
        value: 'start',
        short: 'Avvia'
      },
      {
        name: 'üß™ Esegui Test Sistema',
        value: 'test',
        short: 'Test'
      },
      {
        name: '‚öôÔ∏è  Verifica Configurazione',
        value: 'config',
        short: 'Config'
      },
      {
        name: 'üìã Visualizza Documentazione',
        value: 'docs',
        short: 'Docs'
      },
      {
        name: 'üîß Setup Iniziale',
        value: 'setup',
        short: 'Setup'
      },
      {
        name: '‚ùå Esci',
        value: 'exit',
        short: 'Esci'
      }
    ];

    const { action } = await inquirer.prompt([
      {
        type: 'list',
        name: 'action',
        message: 'Seleziona un\'opzione:',
        choices,
        pageSize: 10
      }
    ]);

    return action;
  }

  // Verifica prerequisiti
  async checkPrerequisites() {
    console.log(chalk.blue('üîç Verifica prerequisiti...'));
    
    const checks = [];
    
    // Verifica Node.js
    const nodeVersion = process.version;
    const nodeVersionNum = parseInt(nodeVersion.slice(1).split('.')[0]);
    checks.push({
      name: 'Node.js Version',
      status: nodeVersionNum >= 16,
      message: `${nodeVersion} ${nodeVersionNum >= 16 ? '‚úÖ' : '‚ùå (Richiesto >= 16)'}`
    });
    
    // Verifica dipendenze
    const packageJson = await fs.readJson('./package.json');
    const dependencies = Object.keys(packageJson.dependencies || {});
    let missingDeps = 0;
    
    for (const dep of dependencies) {
      try {
        require(dep);
      } catch (error) {
        missingDeps++;
      }
    }
    
    checks.push({
      name: 'Dipendenze NPM',
      status: missingDeps === 0,
      message: `${dependencies.length - missingDeps}/${dependencies.length} installate ${missingDeps === 0 ? '‚úÖ' : '‚ùå'}`
    });
    
    // Verifica directory
    const requiredDirs = ['./data', './logs', './reports', './backups'];
    let existingDirs = 0;
    
    for (const dir of requiredDirs) {
      if (await fs.pathExists(dir)) {
        existingDirs++;
      }
    }
    
    checks.push({
      name: 'Directory Sistema',
      status: existingDirs === requiredDirs.length,
      message: `${existingDirs}/${requiredDirs.length} create ${existingDirs === requiredDirs.length ? '‚úÖ' : '‚ùå'}`
    });
    
    // Verifica file configurazione
    const configExists = await fs.pathExists('./config.js');
    checks.push({
      name: 'File Configurazione',
      status: configExists,
      message: configExists ? 'Presente ‚úÖ' : 'Mancante ‚ùå'
    });
    
    // Mostra risultati
    console.log('');
    console.log(chalk.blue('üìã Risultati Verifica:'));
    
    for (const check of checks) {
      const icon = check.status ? '‚úÖ' : '‚ùå';
      const color = check.status ? 'green' : 'red';
      console.log(chalk[color](`   ${icon} ${check.name}: ${check.message}`));
    }
    
    const allPassed = checks.every(check => check.status);
    
    console.log('');
    if (allPassed) {
      console.log(chalk.green('üéâ Tutti i prerequisiti sono soddisfatti!'));
    } else {
      console.log(chalk.yellow('‚ö†Ô∏è  Alcuni prerequisiti non sono soddisfatti.'));
      console.log(chalk.white('   Esegui "npm install" e riprova.'));
    }
    
    return allPassed;
  }

  // Setup iniziale
  async performInitialSetup() {
    console.log(chalk.blue('üîß === SETUP INIZIALE === üîß'));
    console.log('');
    
    // Crea directory necessarie
    console.log(chalk.blue('üìÅ Creazione directory...'));
    const directories = ['./data', './logs', './reports', './backups'];
    
    for (const dir of directories) {
      await fs.ensureDir(dir);
      console.log(chalk.green(`   ‚úÖ ${dir}`));
    }
    
    // Verifica file .env
    if (!(await fs.pathExists('./.env'))) {
      console.log('');
      console.log(chalk.blue('‚öôÔ∏è  Configurazione ambiente...'));
      
      const { createEnv } = await inquirer.prompt([
        {
          type: 'confirm',
          name: 'createEnv',
          message: 'Creare file .env dalla template?',
          default: true
        }
      ]);
      
      if (createEnv) {
        await fs.copy('./.env.example', './.env');
        console.log(chalk.green('   ‚úÖ File .env creato'));
        console.log(chalk.yellow('   ‚ö†Ô∏è  Ricorda di configurare le variabili in .env'));
      }
    }
    
    // Verifica keypair
    const keypairExists = await fs.pathExists('./keypair.json');
    
    if (!keypairExists) {
      console.log('');
      console.log(chalk.blue('üîë Generazione keypair...'));
      
      const { generateKeypair } = await inquirer.prompt([
        {
          type: 'confirm',
          name: 'generateKeypair',
          message: 'Generare nuovo keypair Solana?',
          default: true
        }
      ]);
      
      if (generateKeypair) {
        const { Keypair } = require('@solana/web3.js');
        const keypair = Keypair.generate();
        
        await fs.writeJson('./keypair.json', Array.from(keypair.secretKey), { spaces: 2 });
        
        console.log(chalk.green('   ‚úÖ Keypair generato'));
        console.log(chalk.white(`   üìç Indirizzo: ${keypair.publicKey.toString()}`));
        console.log(chalk.yellow('   ‚ö†Ô∏è  IMPORTANTE: Salva il keypair in modo sicuro!'));
      }
    }
    
    console.log('');
    console.log(chalk.green('üéâ Setup completato con successo!'));
  }

  // Mostra documentazione
  async showDocumentation() {
    console.log(chalk.blue('üìã === DOCUMENTAZIONE LUNACOIN === üìã'));
    console.log('');
    
    console.log(chalk.cyan('üöÄ AVVIO RAPIDO:'));
    console.log(chalk.white('   1. Esegui "node start.js"'));
    console.log(chalk.white('   2. Seleziona "Setup Iniziale" se √® la prima volta'));
    console.log(chalk.white('   3. Configura il file .env con le tue API key'));
    console.log(chalk.white('   4. Avvia il sistema completo'));
    console.log('');
    
    console.log(chalk.cyan('‚öôÔ∏è  CONFIGURAZIONE:'));
    console.log(chalk.white('   ‚Ä¢ config.js: Configurazione principale del token'));
    console.log(chalk.white('   ‚Ä¢ .env: Variabili d\'ambiente e API key'));
    console.log(chalk.white('   ‚Ä¢ keypair.json: Chiavi del wallet (MANTIENI SICURO!)'));
    console.log('');
    
    console.log(chalk.cyan('üìÅ STRUTTURA FILE:'));
    console.log(chalk.white('   ‚Ä¢ /data: Dati del sistema e metriche'));
    console.log(chalk.white('   ‚Ä¢ /logs: File di log del sistema'));
    console.log(chalk.white('   ‚Ä¢ /reports: Report e statistiche'));
    console.log(chalk.white('   ‚Ä¢ /backups: Backup automatici'));
    console.log('');
    
    console.log(chalk.cyan('üîß COMANDI UTILI:'));
    console.log(chalk.white('   ‚Ä¢ node start.js: Avvia il launcher'));
    console.log(chalk.white('   ‚Ä¢ node index.js: Avvia direttamente il sistema'));
    console.log(chalk.white('   ‚Ä¢ node test.js: Esegui test del sistema'));
    console.log(chalk.white('   ‚Ä¢ npm run generate: Genera token'));
    console.log(chalk.white('   ‚Ä¢ npm run monitor: Avvia monitoraggio'));
    console.log('');
    
    console.log(chalk.cyan('üåê NETWORK SUPPORTATI:'));
    console.log(chalk.white('   ‚Ä¢ Mainnet: Produzione (richiede SOL reali)'));
    console.log(chalk.white('   ‚Ä¢ Devnet: Test (SOL gratuiti dal faucet)'));
    console.log(chalk.white('   ‚Ä¢ Testnet: Test avanzati'));
    console.log('');
    
    console.log(chalk.cyan('üîí SICUREZZA:'));
    console.log(chalk.white('   ‚Ä¢ Non condividere mai il keypair.json'));
    console.log(chalk.white('   ‚Ä¢ Usa sempre backup crittografati'));
    console.log(chalk.white('   ‚Ä¢ Verifica sempre gli indirizzi dei contratti'));
    console.log(chalk.white('   ‚Ä¢ Testa sempre su devnet prima di mainnet'));
    console.log('');
    
    console.log(chalk.cyan('üìû SUPPORTO:'));
    console.log(chalk.white('   ‚Ä¢ Controlla i log in ./logs/ per errori'));
    console.log(chalk.white('   ‚Ä¢ Esegui test.js per diagnosticare problemi'));
    console.log(chalk.white('   ‚Ä¢ Verifica la configurazione in config.js'));
    console.log('');
  }

  // Verifica configurazione
  async checkConfiguration() {
    console.log(chalk.blue('‚öôÔ∏è  === VERIFICA CONFIGURAZIONE === ‚öôÔ∏è'));
    console.log('');
    
    try {
      const config = require('./config');
      
      console.log(chalk.blue('üéØ Configurazione Token:'));
      console.log(chalk.white(`   Nome: ${config.token.name}`));
      console.log(chalk.white(`   Simbolo: ${config.token.symbol}`));
      console.log(chalk.white(`   Decimali: ${config.token.decimals}`));
      console.log(chalk.white(`   Supply: ${config.token.totalSupply.toLocaleString()}`));
      console.log('');
      
      console.log(chalk.blue('üåê Configurazione Solana:'));
      console.log(chalk.white(`   Network: ${config.solana.network}`));
      console.log(chalk.white(`   RPC URL: ${config.solana.rpcUrl}`));
      console.log('');
      
      console.log(chalk.blue('üåä Configurazione DEX:'));
      console.log(chalk.white(`   Raydium: ${config.dex.raydium.enabled ? 'Abilitato' : 'Disabilitato'}`));
      console.log(chalk.white(`   Orca: ${config.dex.orca.enabled ? 'Abilitato' : 'Disabilitato'}`));
      console.log(chalk.white(`   Jupiter: ${config.dex.jupiter.enabled ? 'Abilitato' : 'Disabilitato'}`));
      console.log('');
      
      console.log(chalk.blue('üîí Configurazione Sicurezza:'));
      console.log(chalk.white(`   Lock Liquidit√†: ${config.security.liquidityLock ? 'S√¨' : 'No'}`));
      console.log(chalk.white(`   Rinuncia Autorit√†: ${config.security.renounceAuthorities ? 'S√¨' : 'No'}`));
      console.log('');
      
      // Verifica file .env
      if (await fs.pathExists('./.env')) {
        console.log(chalk.green('‚úÖ File .env presente'));
      } else {
        console.log(chalk.yellow('‚ö†Ô∏è  File .env mancante'));
      }
      
      // Verifica keypair
      if (await fs.pathExists('./keypair.json')) {
        console.log(chalk.green('‚úÖ Keypair presente'));
      } else {
        console.log(chalk.yellow('‚ö†Ô∏è  Keypair mancante'));
      }
      
    } catch (error) {
      console.log(chalk.red('‚ùå Errore nel caricamento configurazione:'));
      console.log(chalk.red(`   ${error.message}`));
    }
  }

  // Avvia il sistema
  async run() {
    try {
      this.showStartupBanner();
      
      while (true) {
        console.log('');
        const action = await this.showStartupMenu();
        console.log('');
        
        switch (action) {
          case 'start':
            // Verifica prerequisiti prima di avviare
            const prerequisitesPassed = await this.checkPrerequisites();
            
            if (!prerequisitesPassed) {
              console.log(chalk.yellow('‚ö†Ô∏è  Risolvi i problemi sopra prima di continuare.'));
              break;
            }
            
            console.log(chalk.green('üöÄ Avvio sistema...'));
            await this.system.run();
            return; // Il sistema prende il controllo
            
          case 'test':
            console.log(chalk.blue('üß™ Esecuzione test...'));
            const testResult = await this.tester.runAllTests();
            
            if (testResult) {
              console.log(chalk.green('üéâ Tutti i test sono passati! Il sistema √® pronto.'));
            } else {
              console.log(chalk.yellow('‚ö†Ô∏è  Alcuni test sono falliti. Controlla i dettagli sopra.'));
            }
            break;
            
          case 'config':
            await this.checkConfiguration();
            break;
            
          case 'docs':
            await this.showDocumentation();
            break;
            
          case 'setup':
            await this.performInitialSetup();
            break;
            
          case 'exit':
            console.log(chalk.yellow('üëã Arrivederci!'));
            process.exit(0);
            
          default:
            console.log(chalk.red('‚ùå Opzione non riconosciuta'));
        }
        
        // Pausa prima del prossimo menu
        await inquirer.prompt([
          {
            type: 'input',
            name: 'continue',
            message: 'Premi INVIO per continuare...'
          }
        ]);
      }
      
    } catch (error) {
      console.error(chalk.red('üí• ERRORE CRITICO DEL LAUNCHER:'), error.message);
      process.exit(1);
    }
  }
}

// Gestione segnali di sistema
process.on('SIGINT', () => {
  console.log('\n' + chalk.yellow('üëã Arresto launcher...'));
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('\n' + chalk.yellow('üëã Arresto launcher...'));
  process.exit(0);
});

// Avvio launcher se eseguito direttamente
if (require.main === module) {
  const launcher = new SystemLauncher();
  launcher.run();
}

module.exports = SystemLauncher;